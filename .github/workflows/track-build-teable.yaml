name: Track Build in Teable

on:
  workflow_call:
    inputs:
      action:
        description: 'Action to perform: create or update'
        required: true
        type: string
      edition:
        description: 'Edition: cloud or ee'
        required: true
        type: string
      record_id:
        description: 'Record ID for update action'
        required: false
        type: string
      status:
        description: 'Status: Building, Released, or Fail'
        required: false
        type: string
        default: 'Building'
      start_time:
        description: 'Start timestamp in seconds for duration calculation'
        required: false
        type: string
    outputs:
      record_id:
        description: 'The Teable record ID'
        value: ${{ jobs.track.outputs.record_id }}
      version_tag:
        description: 'The generated version tag'
        value: ${{ jobs.track.outputs.version_tag }}
      start_time:
        description: 'The start timestamp'
        value: ${{ jobs.track.outputs.start_time }}
    secrets:
      TEABLE_API_TOKEN:
        required: true
      PACKAGES_KEY:
        required: true

jobs:
  track:
    runs-on: ubuntu-latest
    outputs:
      record_id: ${{ steps.create_record.outputs.record_id || steps.update_record.outputs.record_id }}
      version_tag: ${{ steps.generate_version.outputs.version_tag }}
      start_time: ${{ steps.record_time.outputs.start_time }}
    
    steps:
      - name: Record start time
        id: record_time
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          repository: teableio/teable-ee
          token: ${{ secrets.PACKAGES_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.18.0

      - name: Generate version tag
        id: generate_version
        run: |
          # Read versions from package.json files
          ee_version=$(node -p "require('./enterprise/app-ee/package.json').version")
          ce_version=$(node -p "require('./community/apps/nextjs-app/package.json').version")
          
          # Generate version tag without architecture suffix (for multi-arch manifest)
          version_tag="${ee_version}-alpha-${ce_version}-build.${{ github.run_number }}"
          echo "version_tag=${version_tag}" >> $GITHUB_OUTPUT
          echo "Generated version tag: ${version_tag}"

      - name: Get commit info
        id: get_ee_commit
        run: |
          commit_sha=$(git rev-parse HEAD)
          commit_message=$(git log -1 --pretty=format:'%s')
          commit_author=$(git log -1 --pretty=format:'%an')
          
          echo "sha=${commit_sha}" >> $GITHUB_OUTPUT
          echo "message=${commit_message}" >> $GITHUB_OUTPUT
          echo "author=${commit_author}" >> $GITHUB_OUTPUT

      - name: Extract PR number
        id: extract_pr
        run: |
          commit_message="${{ steps.get_ee_commit.outputs.message }}"
          # Try to extract PR number from commit message
          # Support format 1: (#456)
          # Support format 2: Merge pull request #735 from ...
          pr_number=$(echo "$commit_message" | grep -oP '\(#\K\d+(?=\))' || echo "$commit_message" | grep -oP '(?<=pull request #)\d+' || echo "")
          echo "pr_number=${pr_number}" >> $GITHUB_OUTPUT
          echo "Extracted PR number: ${pr_number}"

      - name: Create Teable record
        if: inputs.action == 'create'
        id: create_record
        env:
          TAG: ${{ steps.generate_version.outputs.version_tag }}
          STATUS: ${{ inputs.status }}
          EDITION: ${{ inputs.edition }}
          COMMIT_MESSAGE: ${{ steps.get_ee_commit.outputs.message }}
          COMMIT: ${{ steps.get_ee_commit.outputs.sha }}
          AUTHOR: ${{ steps.get_ee_commit.outputs.author }}
          PR: ${{ steps.extract_pr.outputs.pr_number }}
          RUNS: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # Build JSON payload using jq to properly escape special characters
          payload=$(jq -n \
            --arg tag "$TAG" \
            --arg status "$STATUS" \
            --arg edition "$EDITION" \
            --arg commit_message "$COMMIT_MESSAGE" \
            --arg commit "$COMMIT" \
            --arg author "$AUTHOR" \
            --arg pr "$PR" \
            --arg runs "$RUNS" \
            '{
              "fieldKeyType": "dbFieldName",
              "records": [
                {
                  "fields": {
                    "tag": $tag,
                    "status": $status,
                    "edition": $edition,
                    "commit_message": $commit_message,
                    "commit": $commit,
                    "author": $author,
                    "pull_request": $pr,
                    "runs": $runs
                  }
                }
              ]
            }')
          
          # Make the API call and capture both response and HTTP status code
          http_code=$(curl -s -w "%{http_code}" -o /tmp/response.json -X POST 'https://app.teable.ai/api/table/tblAhVLOxNtvkaF1ii5/record' \
            -H 'Authorization: Bearer ${{ secrets.TEABLE_API_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d "$payload")
          
          response=$(cat /tmp/response.json)
          echo "Response: $response"
          echo "HTTP Status Code: $http_code"
          
          # Check if request was successful
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            # Extract record ID from response
            record_id=$(echo "$response" | jq -r '.records[0].id')
            echo "record_id=${record_id}" >> $GITHUB_OUTPUT
            echo "Created record with ID: ${record_id}"
          else
            echo "Error: API request failed with status code $http_code"
            echo "Response: $response"
            exit 1
          fi

      - name: Calculate duration
        if: inputs.action == 'update'
        id: calc_duration
        run: |
          end_time=$(date +%s)
          start_time=${{ inputs.start_time }}
          duration=$((end_time - start_time))
          # Convert to minutes
          duration_minutes=$((duration / 60))
          echo "duration=${duration_minutes}" >> $GITHUB_OUTPUT
          echo "Duration: ${duration_minutes} minutes"

      - name: Update Teable record
        if: inputs.action == 'update'
        id: update_record
        env:
          STATUS: ${{ inputs.status }}
          DURATION: ${{ steps.calc_duration.outputs.duration }}
          RECORD_ID: ${{ inputs.record_id }}
        run: |
          # Build JSON payload using jq to properly escape special characters
          payload=$(jq -n \
            --arg status "$STATUS" \
            --argjson duration "$DURATION" \
            '{
              "fieldKeyType": "dbFieldName",
              "record": {
                "fields": {
                  "status": $status,
                  "duration": $duration
                }
              }
            }')
          
          # Make the API call and capture both response and HTTP status code
          http_code=$(curl -s -w "%{http_code}" -o /tmp/response.json -X PATCH "https://app.teable.ai/api/table/tblAhVLOxNtvkaF1ii5/record/$RECORD_ID" \
            -H 'Authorization: Bearer ${{ secrets.TEABLE_API_TOKEN }}' \
            -H 'Content-Type: application/json' \
            -d "$payload")
          
          response=$(cat /tmp/response.json)
          echo "Response: $response"
          echo "HTTP Status Code: $http_code"
          
          # Check if request was successful
          if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
            echo "record_id=$RECORD_ID" >> $GITHUB_OUTPUT
            echo "Updated record $RECORD_ID with status: $STATUS"
          else
            echo "Error: API request failed with status code $http_code"
            echo "Response: $response"
            exit 1
          fi

